services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: always

    env_file:
      - /opt/streamline/config/.env

    environment:
      - GENERIC_TIMEZONE=Europe/Paris
      - N8N_BASIC_AUTH_ACTIVE=true

      # n8n écoute en HTTP dans le conteneur
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http

      # URL publique derrière Traefik
      - N8N_EDITOR_BASE_URL=https://app.streamline-internal.com
      - N8N_DIAGNOSTICS_DISABLED=true

      # ✅ Demande officielle à n8n d'utiliser ce favicon dans le <head>
      - N8N_PERSONALIZATION_ENABLED=true
      - N8N_PERSONALIZATION_BRANDING_FAVICON=https://n8n.io/favicon.ico

    volumes:
      - /opt/streamline/data/n8n:/home/node/.n8n

    ports:
      - "5678:5678"

    networks:
      - web

    labels:
      - traefik.enable=true

      # Route HTTPS principale vers n8n
      - traefik.http.routers.n8n-https.rule=Host(`app.streamline-internal.com`)
      - traefik.http.routers.n8n-https.entrypoints=websecure
      - traefik.http.routers.n8n-https.tls=true

      - traefik.http.services.n8n.loadbalancer.server.scheme=http
      - traefik.http.services.n8n.loadbalancer.server.port=5678
      - traefik.http.services.n8n.loadbalancer.passhostheader=true

networks:
  web:
    external: true
